<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EventScape — Dashboard</title>
  <link rel="stylesheet" href="global.css" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="event-dashboard" id="dashboard-root">
    <!-- Base white sections -->
    <img class="dashboard-left-white" src="dashboard-left-white-square.svg" alt="" aria-hidden="true" />
    <img class="dashboard-main-white" src="dashboard-main-white-square.svg" alt="" aria-hidden="true" />
    <img class="dashboard-stats" src="dashboard-stats-square.svg" alt="" aria-hidden="true" />
    <div class="dashboard" id="dashboard-main">
      <div class="dashboard" id="dashboard-main">
        <% var _panel=(typeof panel !=='undefined' ) ? panel.trim() : 'profile' ; var _events=(typeof events
          !=='undefined' && Array.isArray(events)) ? events : []; var hasEvents=_events.length> 0;

          var _announcements = (typeof announcements !== 'undefined' && Array.isArray(announcements)) ? announcements : [];
          var _invitations = (typeof invitations !== 'undefined' && Array.isArray(invitations)) ? invitations : [];
          var _rsvpd = (typeof rsvpd !== 'undefined' && Array.isArray(rsvpd)) ? rsvpd : [];

          var hasAnnouncements = _announcements.length > 0;
          var hasInvitations = _invitations.length > 0;
          var hasRsvpd = _rsvpd.length > 0;
        %>
          
          <% if (_panel==='events' ) { %>
            <section class="events-panel">
              <h2>Upcoming Events</h2>

              <% if (hasEvents) { %>
                <table class="events-table">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Location</th>
                      <th>Start Time</th>
                      <th>End Time</th>
                      <th>Capacity</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% _events.forEach(function(e){ %>
                      <tr>
                        <td>
                          <%= e.title %>
                        </td>
                        <td>
                          <%= e.location || '—' %>
                        </td>
                        <td>
                          <%= new Date(e.start_time).toLocaleString() %>
                        </td>
                        <td>
                          <%= e.end_time ? new Date(e.end_time).toLocaleString() : '—' %>
                        </td>
                        <td>
                          <%= (e.capacity===null || e.capacity===undefined) ? '—' : e.capacity %>
                        </td>
                      </tr>
                      <% }); %>
                  </tbody>
                </table>
                <% } else { %>
                  <p class="no-events-msg">No upcoming events.</p>
                  <% } %>
            </section>

            <!-- Code for your-events -->
            <% } else if (_panel==='your-events' ) { %>
              
              <section class="events-panel">
                <h2>Your Events</h2>

                <table class="events-table">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Location</th>
                      <th>Start Time</th>
                      <th>End Time</th>
                      <th>Capacity</th>
                      <th>Going</th>
                      <th>Announce</th>
                      <th>Edit</th>
                      <th>Delete</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (hasEvents) { _events.forEach(function(e){ 
                        var editing = (typeof editingId !== 'undefined' && editingId && (editingId === e.event_id));
                    %>
                      <% if (!editing) { %>
                        <!-- NORMAL ROW -->
                        <tr>
                          <td><%= e.title %></td>
                          <td><%= e.location || '—' %></td>
                          <td><%= new Date(e.start_time).toLocaleString() %></td>
                          <td><%= e.end_time ? new Date(e.end_time).toLocaleString() : '—' %></td>
                          <td><%= (e.capacity ?? '—') %></td>
                          <td><%= e.going_count %></td>

                          <!-- Announce -->
                          <td class="announce-cell">
                            <form method="POST" action="/your-events/<%= e.event_id %>/announce">
                              <div class=""announce-col">
                                <input name="content" type="text" placeholder="Announcement content" required />
                                <button type="submit">Announce</button>
                              </div>
                            </form>
                          </td>

                          <!-- Edit -->
                          <td class="edit-cell">
                            <a class="btn" href="/your-events?edit=<%= e.event_id %>">Edit</a>
                          </td>

                          <!-- Delete -->
                          <td>
                            <form method="POST" action="/your-events/<%= e.event_id %>/delete"
                                  onsubmit="return confirm('Delete this event? This cannot be undone.');">
                              <button type="submit" class="danger">Delete</button>
                            </form>
                          </td>
                        </tr>
                      <% } else { %>
                        <!-- EDIT MODE ROW -->
                        <% var formId = 'editForm-' + e.event_id; %>
                        <form id="<%= formId %>" method="POST" action="/your-events/<%= e.event_id %>/update"></form>
                        <tr class="edit-row">
                          <td><input form="<%= formId %>" name="title" value="<%- e.title %>" required /></td>
                          <td><input form="<%= formId %>" name="location" value="<%- e.location || '' %>" /></td>
                          <td><input form="<%= formId %>" type="datetime-local" name="start_time"
                                    value="<%= new Date(e.start_time).toISOString().slice(0,16) %>" required /></td>
                          <td><input form="<%= formId %>" type="datetime-local" name="end_time"
                                    value="<%= e.end_time ? new Date(e.end_time).toISOString().slice(0,16) : '' %>" /></td>
                          <td><input form="<%= formId %>" type="number" name="capacity" min="0"
                                    value="<%= (e.capacity ?? '') %>" /></td>
                          <td><%= e.going_count %></td>

                          <!-- Announce column stays empty in edit mode -->
                          <td></td>

                          <!-- Save / Cancel -->
                          <td>
                            <button form="<%= formId %>" type="submit">Save</button>
                            <a class="btn secondary" href="/your-events">Cancel</a>
                          </td>

                          <!-- Delete -->
                          <td>
                            <form method="POST" action="/your-events/<%= e.event_id %>/delete"
                                  onsubmit="return confirm('Delete this event? This cannot be undone.');">
                              <button type="submit" class="danger">Delete</button>
                            </form>
                          </td>
                        </tr>
                      <% } %>
                    <% }); } else { %>
                      <tr><td colspan="9" class="no-events-msg">You haven’t created any events yet.</td></tr>
                    <% } %>
                  </tbody>
                </table>

                <hr />

                <h3>Create new event</h3>
                <form id="createForm" method="POST" action="/your-events"></form>

                <table class="events-table create-table">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Location</th>
                      <th>Start Time</th>
                      <th>End Time</th>
                      <th>Capacity</th>
                      <th>Visibility</th>
                      <th><!-- submit --></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><input form="createForm" name="title" placeholder="Title" required /></td>
                      <td><input form="createForm" name="location" placeholder="Location" /></td>
                      <td><input form="createForm" type="datetime-local" name="start_time" required /></td>
                      <td><input form="createForm" type="datetime-local" name="end_time" /></td>
                      <td><input form="createForm" type="number" name="capacity" min="0" placeholder="—" /></td>
                      <td>
                        <select form="createForm" name="visibility">
                          <option value="public">public</option>
                          <option value="private">private</option>
                          <option value="unlisted">unlisted</option>
                        </select>
                      </td>
                      <td><button form="createForm" type="submit">Create event</button></td>
                    </tr>
                  </tbody>
                </table>

              </section>


            <% } else if (_panel==='profile' ) { %>
              <section class="profile-panel">
                <h2>Profile Settings</h2>

                <div class="profile-row">
                  <label>Display name</label>
                  <div class="readonly-value">
                    <%= displayName %>
                  </div>
                </div>

                <div class="profile-row">
                  <label>Email</label>
                  <div class="readonly-value">
                    <%= email %>
                  </div>
                </div>

                <form id="notifForm" class="profile-row" method="POST" action="/profile/notification">
                  <label for="notification_setting">Notifications</label>
                  <select id="notification_setting" name="notification_setting"
                    onchange="document.getElementById('notifForm').submit()">
                    <option value="none" <%=notification_setting==='none' ? 'selected' : '' %>>None</option>
                    <option value="email" <%=notification_setting==='email' ? 'selected' : '' %>>Email</option>
                    <option value="in_app" <%=notification_setting==='in_app' ? 'selected' : '' %>>In-app</option>
                    <option value="all" <%=notification_setting==='all' ? 'selected' : '' %>>All</option>
                  </select>
                </form>
                <% if (saved) { %>
                  <div class="profile-saved">Settings saved ✔</div>
                  <% } %>
              </section>

              <% } else if (_panel==='inbox' ) { %>
                <section class="events-panel">
                  <h2>Announcements</h2>
                  <% if (hasAnnouncements) { %>
                    <table class="events-table">
                      <thead>
                        <tr>
                          <th>Title</th>
                          <th>Event</th>
                          <th>Posted</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% _announcements.forEach(function(a){ %>
                          <tr>
                            <td>
                              <%= a.announcement_title %>
                            </td>
                            <td>
                              <%= a.event_title || '—' %>
                            </td>
                            <td>
                              <%= new Date(a.announcement_created_at).toLocaleString() %>
                            </td>
                          </tr>
                          <% }) %>
                      </tbody>
                    </table>
                    <% } else { %>
                      <p class="empty-state">No announcements to view</p>
                      <% } %>
                </section>
                <section class="events-panel invitations-panel">
                  <h2>Invitations</h2>
                  <% if (hasInvitations) { %>
                    <table class="events-table">
                      <thead>
                        <tr>
                          <th>Event</th>
                          <th>Location</th>
                          <th>Start</th>
                          <th>End</th>
                          <th>Capacity</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% _invitations.forEach(function(i){ %>
                          <tr>
                            <td>
                              <%= i.event_title %>
                            </td>
                            <td>
                              <%= i.location %>
                            </td>
                            <td>
                              <%= new Date(i.start_time).toLocaleString() %>
                            </td>
                            <td>
                              <%= new Date(i.end_time).toLocaleString() %>
                            </td>
                            <td>
                              <%= (typeof i.capacity==='number' ) ? i.capacity : '—' %>
                            </td>
                            </td>
                          </tr>
                          <% }) %>
                      </tbody>
                    </table>
                    <% } else { %>
                      <p class="empty-state">No pending invitations</p>
                      <% } %>
                </section>

                <% } else if (_panel==='rsvpd' ) { %>
                  <section class="events-panel">
                    <h2>RSVP’d Events</h2>
                    <% if (hasRsvpd) { %>
                      <table class="events-table">
                        <thead>
                          <tr>
                            <th>Event</th>
                            <th>Location</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>RSVP Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% _rsvpd.forEach(function(r){ %>
                            <tr>
                              <td>
                                <%= r.event_title %>
                              </td>
                              <td>
                                <%= r.location %>
                              </td>
                              <td>
                                <%= new Date(r.start_time).toLocaleString() %>
                              </td>
                              <td>
                                <%= new Date(r.end_time).toLocaleString() %>
                              </td>
                              <td>
                                <%= r.rsvp_status %>
                              </td>
                            </tr>
                            <% }) %>
                        </tbody>
                      </table>
                      <% } else { %>
                        <p class="empty-state">No RSVPs to view</p>
                        <% } %>
                  </section>
                  <% } %>
      </div>

      <!-- Light grey content boxes -->
      <img class="dashboard-light-grey-1" src="dashboard-light-grey-box.svg" alt="" aria-hidden="true" />
      <img class="dashboard-light-grey-2" src="dashboard-light-grey-box.svg" alt="" aria-hidden="true" />
      <img class="dashboard-light-grey-3" src="dashboard-light-grey-box.svg" alt="" aria-hidden="true" />
      <img class="dashboard-light-grey-4" src="dashboard-light-grey-box.svg" alt="" aria-hidden="true" />

      <!-- Stats header overlay -->
      <img class="stats-header" src="stats-header.svg" alt="" aria-hidden="true" />
      <div class="stat stat--upcoming" id="upcoming-count">
        <%= stats.upcoming %>
      </div>
      <div class="stat stat--attended" id="attended-count">
        <%= stats.attended %>
      </div>
      <div class="stat stat--notifications" id="notifications-count">
        <%= stats.notifications %>
      </div>

      <!-- Sidebar text items -->
      <div class="brand">
        <img class="brand-logo" src="logo.svg" alt="EventScape logo" />
        <span class="brand-text">EventScape</span>
      </div>
      <h2 class="greeting">Hi, <%= displayName %>
      </h2>
      <div class="sidebar-actions">
        <a class="pill pill-grey" href="/events">
          <span>Event Dashboard</span>
        </a>

        <a class="pill pill-grey" href="/rsvpd">
          <span>RSVP’d Events</span>
        </a>

        <a class="pill pill-grey" href="/your-events">
          <span>Your Events</span>
        </a>

        <a class="pill pill-grey" href="/inbox">
          <span>Inbox</span>
        </a>

        <a class="pill pill-grey" href="/profile">
          <span>Profile Settings</span>
        </a>

        <a class="pill pill-grey" href="/logout">
          <span>Log out</span>
        </a>
      </div>
    </div>
    <script>
      window.addEventListener("load", function () {
        const greeting = document.querySelector(".greeting");
        if (!greeting) return;

        const maxWidth = 255;
        let fontSize = 20;
        while (greeting.scrollWidth > maxWidth && fontSize > 10) {
          fontSize -= 0.5;
          greeting.style.fontSize = fontSize + "px";
        }
        greeting.style.width = maxWidth + "px";
        greeting.style.textAlign = "center";
      });
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      function updateStat(id, newValue) {
        const el = document.getElementById(id);
        if (el && el.innerText !== String(newValue)) {
          el.innerText = newValue;
          el.classList.add("updated");
          setTimeout(() => el.classList.remove("updated"), 400);
        }
      }

      socket.on("statsChanged", async () => {
        try {
          const response = await fetch("/getDashboardStats");
          const stats = await response.json();

          //update DOM
          updateStat("upcoming-count", stats.upcoming);
          updateStat("attended-count", stats.attended);
          updateStat("notifications-count", stats.notifications);
        } catch (err) {
          console.error("Error updating stats:", err);
        }
      });
    </script>
</body>

</html>